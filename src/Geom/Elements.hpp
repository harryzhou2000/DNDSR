#pragma once

#include <type_traits>
#include <cstdint>
#include "Eigen/Core"
#include <array>

#include "DNDS/Defines.hpp"

namespace Geom::Elem
{
    /**
     * Complying to [CGNS Element standard](https://cgns.github.io/CGNS_docs_current/sids/conv.html)
     *  !note that we use 0 based indexing (CGNS uses 1 based in the link)
     *
     */
    using t_index = int32_t;
    const t_index invalid_index = INT32_MAX;
    using t_real = double;
    using tPoint = Eigen::Vector3d;

    static_assert(std::is_signed_v<t_index>);

    enum ElemType
    {
        UnknownElem = 0,
        Line2 = 1,
        Line3 = 8,

        Tri3 = 2,
        Tri6 = 9,
        Quad4 = 3,
        Quad9 = 10,

        Tet4 = 4,
        Tet10 = 11,
        Hex8 = 5,
        Hex27 = 12,
        Prism6 = 6,
        Prism18 = 13,
        Pyramid5 = 7,
        Pyramid14 = 14,

        ElemType_NUM = 15
    };

    enum ParamSpace
    {
        UnknownPSpace = 0,
        LineSpace = 1,

        TriSpace = 2,
        QuadSpace = 3,

        TetSpace = 4,
        HexSpace = 5,
        PrismSpace = 6,
        PyramidSpace = 7,

        ParamSpace_NUM = 8
    };

    inline constexpr std::array<std::array<t_index, 5>, ElemType_NUM>
    __Get_Dim_Order_NVNNNF()
    {
        std::array<std::array<t_index, 5>, ElemType_NUM> ret{
            std::array<t_index, 5>{invalid_index}};
        for (auto &i : ret)
            for (auto &j : i)
                j = invalid_index;

        using TR = std::array<t_index, 5>;

        //                                  d  o  nv nn nf
        ret[Line2] = TR{1, 1, 2, 2, 0};
        ret[Line3] = TR{1, 2, 2, 3, 0};

        ret[Tri3] = TR{2, 1, 3, 3, 3};
        ret[Tri6] = TR{2, 2, 3, 6, 3};
        ret[Quad4] = TR{2, 1, 4, 4, 4};
        ret[Quad9] = TR{2, 2, 4, 9, 4};

        ret[Tet4] = TR{3, 1, 4, 4, 4};
        ret[Tet10] = TR{3, 2, 4, 10, 4};
        ret[Hex8] = TR{3, 1, 8, 8, 6};
        ret[Hex27] = TR{3, 2, 8, 27, 6};
        ret[Prism6] = TR{3, 1, 6, 6, 5};
        ret[Prism18] = TR{3, 2, 6, 18, 5};
        ret[Pyramid5] = TR{3, 1, 5, 5, 5};
        ret[Pyramid14] = TR{3, 2, 5, 14, 5};
        return ret;
    }

    const auto Dim_Order_NVNNNF = __Get_Dim_Order_NVNNNF();

    inline constexpr ParamSpace ElemType_to_ParamSpace(const ElemType t)
    {
        if (t == Line2 || t == Line3)
            return LineSpace;
        if (t == Tri3 || t == Tri6)
            return TriSpace;
        if (t == Quad4 || t == Quad9)
            return QuadSpace;
        if (t == Tet4 || t == Tet10)
            return TetSpace;
        if (t == Hex8 || t == Hex27)
            return HexSpace;
        if (t == Prism6 || t == Prism18)
            return PrismSpace;
        if (t == Pyramid5 || t == Pyramid14)
            return PyramidSpace;
        return UnknownPSpace;
    }

    inline constexpr ElemType GetFaceType(ElemType t_v, t_index iFace)
    {
        if (t_v == Tri3)
            return Line2;
        if (t_v == Tri6)
            return Line3;
        if (t_v == Quad4)
            return Line2;
        if (t_v == Quad9)
            return Line3;
        if (t_v == Tet4)
            return Tri3;
        if (t_v == Tet10)
            return Tri6;
        if (t_v == Hex8)
            return Quad4;
        if (t_v == Hex27)
            return Quad9;
        if (t_v == Prism6)
        {
            if (iFace < 3)
                return Quad4;
            return Tri3;
        }
        if (t_v == Prism18)
        {
            if (iFace < 3)
                return Quad9;
            return Tri6;
        }
        if (t_v == Pyramid5)
        {
            if (iFace < 1)
                return Quad4;
            return Tri3;
        }
        if (t_v == Pyramid14)
        {
            if (iFace < 1)
                return Quad9;
            return Tri6;
        }
    }

    inline constexpr std::array<std::array<std::array<t_index, 10>, 6>, ElemType_NUM>
    __Get_FaceNodeList()
    {
        auto ret = std::array<std::array<std::array<t_index, 10>, 6>, ElemType_NUM>{};
        for (auto &i : ret)
            for (auto &j : i)
                for (auto &k : j)
                    k = invalid_index;
        using TF = std::array<t_index, 10>;
        ret[Tri3][0] = TF{0, 1};
        ret[Tri3][1] = TF{1, 2};
        ret[Tri3][2] = TF{2, 0};

        ret[Tri6][0] = TF{0, 1, 3};
        ret[Tri6][1] = TF{1, 2, 4};
        ret[Tri6][2] = TF{2, 0, 5};

        ret[Quad4][0] = TF{0, 1};
        ret[Quad4][1] = TF{1, 2};
        ret[Quad4][2] = TF{2, 3};
        ret[Quad4][3] = TF{3, 0};

        ret[Quad9][0] = TF{0, 1, 4};
        ret[Quad9][1] = TF{1, 2, 5};
        ret[Quad9][2] = TF{2, 3, 6};
        ret[Quad9][3] = TF{3, 0, 7};

        auto IndexToZeroBase = [&](ElemType t)
        {
            for (auto &j : ret[t])
                for (auto &k : j)
                    k = (k == invalid_index || k == 0)
                            ? invalid_index
                            : k - 1;
        };

        ret[Tet4][0] = TF{1, 3, 2};
        ret[Tet4][1] = TF{1, 2, 4};
        ret[Tet4][2] = TF{2, 3, 4};
        ret[Tet4][3] = TF{3, 1, 4};
        IndexToZeroBase(Tet4);

        ret[Tet10][0] = TF{1, 3, 2, 7, 6, 5};
        ret[Tet10][1] = TF{1, 2, 4, 5, 9, 8};
        ret[Tet10][2] = TF{2, 3, 4, 6, 10, 9};
        ret[Tet10][3] = TF{3, 1, 4, 7, 8, 10};
        IndexToZeroBase(Tet10);

        ret[Hex8][0] = TF{1, 4, 3, 2};
        ret[Hex8][1] = TF{1, 2, 6, 5};
        ret[Hex8][2] = TF{2, 3, 7, 6};
        ret[Hex8][3] = TF{3, 4, 8, 7};
        ret[Hex8][4] = TF{1, 5, 8, 4};
        ret[Hex8][5] = TF{5, 6, 7, 8};
        IndexToZeroBase(Hex8);

        ret[Hex27][0] = TF{1, 4, 3, 2, 12, 11, 10, 9, 21};
        ret[Hex27][1] = TF{1, 2, 6, 5, 9, 14, 17, 13, 22};
        ret[Hex27][2] = TF{2, 3, 7, 6, 10, 15, 18, 14, 23};
        ret[Hex27][3] = TF{3, 4, 8, 7, 11, 16, 19, 15, 24};
        ret[Hex27][4] = TF{1, 5, 8, 4, 13, 20, 16, 12, 25};
        ret[Hex27][5] = TF{5, 6, 7, 8, 17, 18, 19, 20, 26};
        IndexToZeroBase(Hex27);

        ret[Prism6][0] = TF{1, 2, 5, 4};
        ret[Prism6][1] = TF{2, 3, 6, 5};
        ret[Prism6][2] = TF{3, 1, 4, 6};
        ret[Prism6][3] = TF{1, 3, 2};
        ret[Prism6][4] = TF{4, 5, 6};
        IndexToZeroBase(Prism6);

        ret[Prism18][0] = TF{1, 2, 5, 4, 7, 11, 13, 10, 16};
        ret[Prism18][1] = TF{2, 3, 6, 5, 8, 12, 14, 11, 17};
        ret[Prism18][2] = TF{3, 1, 4, 6, 9, 10, 15, 12, 18};
        ret[Prism18][3] = TF{1, 3, 2, 9, 8, 7};
        ret[Prism18][4] = TF{4, 5, 6, 13, 14, 15};
        IndexToZeroBase(Prism18);

        ret[Pyramid5][0] = TF{1, 4, 3, 2};
        ret[Pyramid5][1] = TF{1, 2, 5};
        ret[Pyramid5][2] = TF{2, 3, 5};
        ret[Pyramid5][3] = TF{3, 4, 5};
        ret[Pyramid5][4] = TF{4, 1, 5};
        IndexToZeroBase(Pyramid5);

        ret[Pyramid14][0] = TF{1, 4, 3, 2, 9, 8, 7, 6, 14};
        ret[Pyramid14][1] = TF{1, 2, 5, 6, 11, 10};
        ret[Pyramid14][2] = TF{2, 3, 5, 7, 12, 11};
        ret[Pyramid14][3] = TF{3, 4, 5, 8, 13, 12};
        ret[Pyramid14][4] = TF{4, 1, 5, 9, 10, 13};
        IndexToZeroBase(Pyramid14);

        return ret;
    }
    const auto FaceNodeList = __Get_FaceNodeList();

    /**
     * @brief calculates shape func matrix,
     * where Di is d_xi, d_et, d_zt when diffOrder == 1
     *
     * @warning
     * ! assumes v to be in good shape and 0 - init
     *
     * @param t type
     * @param p position in param space
     * @param v result value
     */
    template <int diffOrder, class TPoint, class TArray>
    void ShapeFunc_DiNj(ElemType t, const TPoint &p, TArray &v)
    {
        static_assert(diffOrder == 0 || diffOrder == 1);
        t_real xi = p[0];
        t_real et = p[1];
        t_real zt = p[2];

        if (t == Line2)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = xi * (-1.0 / 2.0) + 1.0 / 2.0;
                v(0, 1) = xi / 2.0 + 1.0 / 2.0;
            }
            else
            {
                v(0, 0) = -1.0 / 2.0;
                v(0, 1) = 1.0 / 2.0;
            }
        }

        if (t == Line3)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = (xi * (xi - 1.0)) / 2.0;
                v(0, 1) = (xi * (xi + 1.0)) / 2.0;
                v(0, 2) = -xi * xi + 1.0;
            }
            else
            {
                v(0, 0) = xi - 1.0 / 2.0;
                v(0, 1) = xi + 1.0 / 2.0;
                v(0, 2) = xi * -2.0;
            }
        }

        if (t == Tri3)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = -et - xi + 1.0;
                v(0, 1) = xi;
                v(0, 2) = et;
            }
            else
            {
                v(0, 0) = -1.0;
                v(0, 1) = 1.0;
                v(1, 0) = -1.0;
                v(1, 2) = 1.0;
            }
        }

        if (t == Tri6)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = (et + xi - 1.0) * (et + xi - 1.0 / 2.0) * 2.0;
                v(0, 1) = xi * (xi - 1.0 / 2.0) * 2.0;
                v(0, 2) = et * (et - 1.0 / 2.0) * 2.0;
                v(0, 3) = xi * (et * 2.0 + xi * 2.0 - 2.0) * -2.0;
                v(0, 4) = et * xi * 4.0;
                v(0, 5) = et * (et + xi - 1.0) * -4.0;
            }
            else
            {
                v(0, 0) = et * 4.0 + xi * 4.0 - 3.0;
                v(0, 1) = xi * 4.0 - 1.0;
                v(0, 3) = et * -4.0 - xi * 8.0 + 4.0;
                v(0, 4) = et * 4.0;
                v(0, 5) = et * -4.0;
                v(1, 0) = et * 4.0 + xi * 4.0 - 3.0;
                v(1, 2) = et * 4.0 - 1.0;
                v(1, 3) = xi * -4.0;
                v(1, 4) = xi * 4.0;
                v(1, 5) = et * -8.0 - xi * 4.0 + 4.0;
            }
        }

        if (t == Quad4)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = (et / 2.0 - 1.0 / 2.0) * (xi / 2.0 - 1.0 / 2.0);
                v(0, 1) = -(et / 2.0 - 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0);
                v(0, 2) = (et / 2.0 + 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0);
                v(0, 3) = -(et / 2.0 + 1.0 / 2.0) * (xi / 2.0 - 1.0 / 2.0);
            }
            else
            {
                v(0, 0) = et / 4.0 - 1.0 / 4.0;
                v(0, 1) = et * (-1.0 / 4.0) + 1.0 / 4.0;
                v(0, 2) = et / 4.0 + 1.0 / 4.0;
                v(0, 3) = et * (-1.0 / 4.0) - 1.0 / 4.0;
                v(1, 0) = xi / 4.0 - 1.0 / 4.0;
                v(1, 1) = xi * (-1.0 / 4.0) - 1.0 / 4.0;
                v(1, 2) = xi / 4.0 + 1.0 / 4.0;
                v(1, 3) = xi * (-1.0 / 4.0) + 1.0 / 4.0;
            }
        }

        if (t == Quad9)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = (et * xi * (et - 1.0) * (xi - 1.0)) / 4.0;
                v(0, 1) = (et * xi * (et - 1.0) * (xi + 1.0)) / 4.0;
                v(0, 2) = (et * xi * (et + 1.0) * (xi + 1.0)) / 4.0;
                v(0, 3) = (et * xi * (et + 1.0) * (xi - 1.0)) / 4.0;
                v(0, 4) = et * (et - 1.0) * (xi - 1.0) * (xi + 1.0) * (-1.0 / 2.0);
                v(0, 5) = xi * (et - 1.0) * (et + 1.0) * (xi + 1.0) * (-1.0 / 2.0);
                v(0, 6) = et * (et + 1.0) * (xi - 1.0) * (xi + 1.0) * (-1.0 / 2.0);
                v(0, 7) = xi * (et - 1.0) * (et + 1.0) * (xi - 1.0) * (-1.0 / 2.0);
                v(0, 8) = (et - 1.0) * (et + 1.0) * (xi - 1.0) * (xi + 1.0);
            }
            else
            {
                v(0, 0) = (et * (xi * 2.0 - 1.0) * (et - 1.0)) / 4.0;
                v(0, 1) = (et * (xi * 2.0 + 1.0) * (et - 1.0)) / 4.0;
                v(0, 2) = (et * (xi * 2.0 + 1.0) * (et + 1.0)) / 4.0;
                v(0, 3) = (et * (xi * 2.0 - 1.0) * (et + 1.0)) / 4.0;
                v(0, 4) = -et * xi * (et - 1.0);
                v(0, 5) = (et * et - 1.0) * (xi * 2.0 + 1.0) * (-1.0 / 2.0);
                v(0, 6) = -et * xi * (et + 1.0);
                v(0, 7) = (et * et - 1.0) * (xi * 2.0 - 1.0) * (-1.0 / 2.0);
                v(0, 8) = xi * (et * et - 1.0) * 2.0;
                v(1, 0) = (xi * (et * 2.0 - 1.0) * (xi - 1.0)) / 4.0;
                v(1, 1) = (xi * (et * 2.0 - 1.0) * (xi + 1.0)) / 4.0;
                v(1, 2) = (xi * (et * 2.0 + 1.0) * (xi + 1.0)) / 4.0;
                v(1, 3) = (xi * (et * 2.0 + 1.0) * (xi - 1.0)) / 4.0;
                v(1, 4) = (et * 2.0 - 1.0) * (xi * xi - 1.0) * (-1.0 / 2.0);
                v(1, 5) = -et * xi * (xi + 1.0);
                v(1, 6) = (et * 2.0 + 1.0) * (xi * xi - 1.0) * (-1.0 / 2.0);
                v(1, 7) = -et * xi * (xi - 1.0);
                v(1, 8) = et * (xi * xi - 1.0) * 2.0;
            }
        }

        if (t == Tet4)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = -et - xi - zt + 1.0;
                v(0, 1) = xi;
                v(0, 2) = et;
                v(0, 3) = zt;
            }
            else
            {
                v(0, 0) = -1.0;
                v(0, 1) = 1.0;
                v(1, 0) = -1.0;
                v(1, 2) = 1.0;
                v(2, 0) = -1.0;
                v(2, 3) = 1.0;
            }
        }

        if (t == Tet10)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = (et + xi + zt - 1.0) * (et + xi + zt - 1.0 / 2.0) * 2.0;
                v(0, 1) = xi * (xi - 1.0 / 2.0) * 2.0;
                v(0, 2) = et * (et - 1.0 / 2.0) * 2.0;
                v(0, 3) = zt * (zt - 1.0 / 2.0) * 2.0;
                v(0, 4) = xi * (et * 2.0 + xi * 2.0 + zt * 2.0 - 2.0) * -2.0;
                v(0, 5) = et * xi * 4.0;
                v(0, 6) = et * (et + xi + zt - 1.0) * -4.0;
                v(0, 7) = zt * (et * 2.0 + xi * 2.0 + zt * 2.0 - 2.0) * -2.0;
                v(0, 8) = xi * zt * 4.0;
                v(0, 9) = et * zt * 4.0;
            }
            else
            {
                v(0, 0) = et * 4.0 + xi * 4.0 + zt * 4.0 - 3.0;
                v(0, 1) = xi * 4.0 - 1.0;
                v(0, 4) = et * -4.0 - xi * 8.0 - zt * 4.0 + 4.0;
                v(0, 5) = et * 4.0;
                v(0, 6) = et * -4.0;
                v(0, 7) = zt * -4.0;
                v(0, 8) = zt * 4.0;
                v(1, 0) = et * 4.0 + xi * 4.0 + zt * 4.0 - 3.0;
                v(1, 2) = et * 4.0 - 1.0;
                v(1, 4) = xi * -4.0;
                v(1, 5) = xi * 4.0;
                v(1, 6) = et * -8.0 - xi * 4.0 - zt * 4.0 + 4.0;
                v(1, 7) = zt * -4.0;
                v(1, 9) = zt * 4.0;
                v(2, 0) = et * 4.0 + xi * 4.0 + zt * 4.0 - 3.0;
                v(2, 3) = zt * 4.0 - 1.0;
                v(2, 4) = xi * -4.0;
                v(2, 6) = et * -4.0;
                v(2, 7) = et * -4.0 - xi * 4.0 - zt * 8.0 + 4.0;
                v(2, 8) = xi * 4.0;
                v(2, 9) = et * 4.0;
            }
        }

        if (t == Hex8)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = -(et / 2.0 - 1.0 / 2.0) * (xi / 2.0 - 1.0 / 2.0) * (zt / 2.0 - 1.0 / 2.0);
                v(0, 1) = (et / 2.0 - 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0) * (zt / 2.0 - 1.0 / 2.0);
                v(0, 2) = -(et / 2.0 + 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0) * (zt / 2.0 - 1.0 / 2.0);
                v(0, 3) = (et / 2.0 + 1.0 / 2.0) * (xi / 2.0 - 1.0 / 2.0) * (zt / 2.0 - 1.0 / 2.0);
                v(0, 4) = (et / 2.0 - 1.0 / 2.0) * (xi / 2.0 - 1.0 / 2.0) * (zt / 2.0 + 1.0 / 2.0);
                v(0, 5) = -(et / 2.0 - 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0) * (zt / 2.0 + 1.0 / 2.0);
                v(0, 6) = (et / 2.0 + 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0) * (zt / 2.0 + 1.0 / 2.0);
                v(0, 7) = -(et / 2.0 + 1.0 / 2.0) * (xi / 2.0 - 1.0 / 2.0) * (zt / 2.0 + 1.0 / 2.0);
            }
            else
            {
                v(0, 0) = (et / 2.0 - 1.0 / 2.0) * (zt / 2.0 - 1.0 / 2.0) * (-1.0 / 2.0);
                v(0, 1) = ((et / 2.0 - 1.0 / 2.0) * (zt / 2.0 - 1.0 / 2.0)) / 2.0;
                v(0, 2) = (et / 2.0 + 1.0 / 2.0) * (zt / 2.0 - 1.0 / 2.0) * (-1.0 / 2.0);
                v(0, 3) = ((et / 2.0 + 1.0 / 2.0) * (zt / 2.0 - 1.0 / 2.0)) / 2.0;
                v(0, 4) = ((et / 2.0 - 1.0 / 2.0) * (zt / 2.0 + 1.0 / 2.0)) / 2.0;
                v(0, 5) = (et / 2.0 - 1.0 / 2.0) * (zt / 2.0 + 1.0 / 2.0) * (-1.0 / 2.0);
                v(0, 6) = ((et / 2.0 + 1.0 / 2.0) * (zt / 2.0 + 1.0 / 2.0)) / 2.0;
                v(0, 7) = (et / 2.0 + 1.0 / 2.0) * (zt / 2.0 + 1.0 / 2.0) * (-1.0 / 2.0);
                v(1, 0) = (xi / 2.0 - 1.0 / 2.0) * (zt / 2.0 - 1.0 / 2.0) * (-1.0 / 2.0);
                v(1, 1) = ((xi / 2.0 + 1.0 / 2.0) * (zt / 2.0 - 1.0 / 2.0)) / 2.0;
                v(1, 2) = (xi / 2.0 + 1.0 / 2.0) * (zt / 2.0 - 1.0 / 2.0) * (-1.0 / 2.0);
                v(1, 3) = ((xi / 2.0 - 1.0 / 2.0) * (zt / 2.0 - 1.0 / 2.0)) / 2.0;
                v(1, 4) = ((xi / 2.0 - 1.0 / 2.0) * (zt / 2.0 + 1.0 / 2.0)) / 2.0;
                v(1, 5) = (xi / 2.0 + 1.0 / 2.0) * (zt / 2.0 + 1.0 / 2.0) * (-1.0 / 2.0);
                v(1, 6) = ((xi / 2.0 + 1.0 / 2.0) * (zt / 2.0 + 1.0 / 2.0)) / 2.0;
                v(1, 7) = (xi / 2.0 - 1.0 / 2.0) * (zt / 2.0 + 1.0 / 2.0) * (-1.0 / 2.0);
                v(2, 0) = (et / 2.0 - 1.0 / 2.0) * (xi / 2.0 - 1.0 / 2.0) * (-1.0 / 2.0);
                v(2, 1) = ((et / 2.0 - 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0)) / 2.0;
                v(2, 2) = (et / 2.0 + 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0) * (-1.0 / 2.0);
                v(2, 3) = ((et / 2.0 + 1.0 / 2.0) * (xi / 2.0 - 1.0 / 2.0)) / 2.0;
                v(2, 4) = ((et / 2.0 - 1.0 / 2.0) * (xi / 2.0 - 1.0 / 2.0)) / 2.0;
                v(2, 5) = (et / 2.0 - 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0) * (-1.0 / 2.0);
                v(2, 6) = ((et / 2.0 + 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0)) / 2.0;
                v(2, 7) = (et / 2.0 + 1.0 / 2.0) * (xi / 2.0 - 1.0 / 2.0) * (-1.0 / 2.0);
            }
        }
        if (t == Hex27)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = (et * xi * zt * (et - 1.0) * (xi - 1.0) * (zt - 1.0)) / 8.0;
                v(0, 1) = (et * xi * zt * (et - 1.0) * (xi + 1.0) * (zt - 1.0)) / 8.0;
                v(0, 2) = (et * xi * zt * (et + 1.0) * (xi + 1.0) * (zt - 1.0)) / 8.0;
                v(0, 3) = (et * xi * zt * (et + 1.0) * (xi - 1.0) * (zt - 1.0)) / 8.0;
                v(0, 4) = (et * xi * zt * (et - 1.0) * (xi - 1.0) * (zt + 1.0)) / 8.0;
                v(0, 5) = (et * xi * zt * (et - 1.0) * (xi + 1.0) * (zt + 1.0)) / 8.0;
                v(0, 6) = (et * xi * zt * (et + 1.0) * (xi + 1.0) * (zt + 1.0)) / 8.0;
                v(0, 7) = (et * xi * zt * (et + 1.0) * (xi - 1.0) * (zt + 1.0)) / 8.0;
                v(0, 8) = et * zt * (et - 1.0) * (xi - 1.0) * (xi + 1.0) * (zt - 1.0) * (-1.0 / 4.0);
                v(0, 9) = xi * zt * (et - 1.0) * (et + 1.0) * (xi + 1.0) * (zt - 1.0) * (-1.0 / 4.0);
                v(0, 10) = et * zt * (et + 1.0) * (xi - 1.0) * (xi + 1.0) * (zt - 1.0) * (-1.0 / 4.0);
                v(0, 11) = xi * zt * (et - 1.0) * (et + 1.0) * (xi - 1.0) * (zt - 1.0) * (-1.0 / 4.0);
                v(0, 12) = et * xi * (et - 1.0) * (xi - 1.0) * (zt - 1.0) * (zt + 1.0) * (-1.0 / 4.0);
                v(0, 13) = et * xi * (et - 1.0) * (xi + 1.0) * (zt - 1.0) * (zt + 1.0) * (-1.0 / 4.0);
                v(0, 14) = et * xi * (et + 1.0) * (xi + 1.0) * (zt - 1.0) * (zt + 1.0) * (-1.0 / 4.0);
                v(0, 15) = et * xi * (et + 1.0) * (xi - 1.0) * (zt - 1.0) * (zt + 1.0) * (-1.0 / 4.0);
                v(0, 16) = et * zt * (et - 1.0) * (xi - 1.0) * (xi + 1.0) * (zt + 1.0) * (-1.0 / 4.0);
                v(0, 17) = xi * zt * (et - 1.0) * (et + 1.0) * (xi + 1.0) * (zt + 1.0) * (-1.0 / 4.0);
                v(0, 18) = et * zt * (et + 1.0) * (xi - 1.0) * (xi + 1.0) * (zt + 1.0) * (-1.0 / 4.0);
                v(0, 19) = xi * zt * (et - 1.0) * (et + 1.0) * (xi - 1.0) * (zt + 1.0) * (-1.0 / 4.0);
                v(0, 20) = (zt * (et - 1.0) * (et + 1.0) * (xi - 1.0) * (xi + 1.0) * (zt - 1.0)) / 2.0;
                v(0, 21) = (et * (et - 1.0) * (xi - 1.0) * (xi + 1.0) * (zt - 1.0) * (zt + 1.0)) / 2.0;
                v(0, 22) = (xi * (et - 1.0) * (et + 1.0) * (xi + 1.0) * (zt - 1.0) * (zt + 1.0)) / 2.0;
                v(0, 23) = (et * (et + 1.0) * (xi - 1.0) * (xi + 1.0) * (zt - 1.0) * (zt + 1.0)) / 2.0;
                v(0, 24) = (xi * (et - 1.0) * (et + 1.0) * (xi - 1.0) * (zt - 1.0) * (zt + 1.0)) / 2.0;
                v(0, 25) = (zt * (et - 1.0) * (et + 1.0) * (xi - 1.0) * (xi + 1.0) * (zt + 1.0)) / 2.0;
                v(0, 26) = -(et - 1.0) * (et + 1.0) * (xi - 1.0) * (xi + 1.0) * (zt - 1.0) * (zt + 1.0);
            }
            else
            {
                v(0, 0) = (et * zt * (xi * 2.0 - 1.0) * (et - 1.0) * (zt - 1.0)) / 8.0;
                v(0, 1) = (et * zt * (xi * 2.0 + 1.0) * (et - 1.0) * (zt - 1.0)) / 8.0;
                v(0, 2) = (et * zt * (xi * 2.0 + 1.0) * (et + 1.0) * (zt - 1.0)) / 8.0;
                v(0, 3) = (et * zt * (xi * 2.0 - 1.0) * (et + 1.0) * (zt - 1.0)) / 8.0;
                v(0, 4) = (et * zt * (xi * 2.0 - 1.0) * (et - 1.0) * (zt + 1.0)) / 8.0;
                v(0, 5) = (et * zt * (xi * 2.0 + 1.0) * (et - 1.0) * (zt + 1.0)) / 8.0;
                v(0, 6) = (et * zt * (xi * 2.0 + 1.0) * (et + 1.0) * (zt + 1.0)) / 8.0;
                v(0, 7) = (et * zt * (xi * 2.0 - 1.0) * (et + 1.0) * (zt + 1.0)) / 8.0;
                v(0, 8) = et * xi * zt * (et - 1.0) * (zt - 1.0) * (-1.0 / 2.0);
                v(0, 9) = zt * (et * et - 1.0) * (xi * 2.0 + 1.0) * (zt - 1.0) * (-1.0 / 4.0);
                v(0, 10) = et * xi * zt * (et + 1.0) * (zt - 1.0) * (-1.0 / 2.0);
                v(0, 11) = zt * (et * et - 1.0) * (xi * 2.0 - 1.0) * (zt - 1.0) * (-1.0 / 4.0);
                v(0, 12) = et * (xi * 2.0 - 1.0) * (zt * zt - 1.0) * (et - 1.0) * (-1.0 / 4.0);
                v(0, 13) = et * (xi * 2.0 + 1.0) * (zt * zt - 1.0) * (et - 1.0) * (-1.0 / 4.0);
                v(0, 14) = et * (xi * 2.0 + 1.0) * (zt * zt - 1.0) * (et + 1.0) * (-1.0 / 4.0);
                v(0, 15) = et * (xi * 2.0 - 1.0) * (zt * zt - 1.0) * (et + 1.0) * (-1.0 / 4.0);
                v(0, 16) = et * xi * zt * (et - 1.0) * (zt + 1.0) * (-1.0 / 2.0);
                v(0, 17) = zt * (et * et - 1.0) * (xi * 2.0 + 1.0) * (zt + 1.0) * (-1.0 / 4.0);
                v(0, 18) = et * xi * zt * (et + 1.0) * (zt + 1.0) * (-1.0 / 2.0);
                v(0, 19) = zt * (et * et - 1.0) * (xi * 2.0 - 1.0) * (zt + 1.0) * (-1.0 / 4.0);
                v(0, 20) = xi * zt * (et * et - 1.0) * (zt - 1.0);
                v(0, 21) = et * xi * (zt * zt - 1.0) * (et - 1.0);
                v(0, 22) = ((et * et - 1.0) * (xi * 2.0 + 1.0) * (zt * zt - 1.0)) / 2.0;
                v(0, 23) = et * xi * (zt * zt - 1.0) * (et + 1.0);
                v(0, 24) = ((et * et - 1.0) * (xi * 2.0 - 1.0) * (zt * zt - 1.0)) / 2.0;
                v(0, 25) = xi * zt * (et * et - 1.0) * (zt + 1.0);
                v(0, 26) = xi * (et * et - 1.0) * (zt * zt - 1.0) * -2.0;
                v(1, 0) = (xi * zt * (et * 2.0 - 1.0) * (xi - 1.0) * (zt - 1.0)) / 8.0;
                v(1, 1) = (xi * zt * (et * 2.0 - 1.0) * (xi + 1.0) * (zt - 1.0)) / 8.0;
                v(1, 2) = (xi * zt * (et * 2.0 + 1.0) * (xi + 1.0) * (zt - 1.0)) / 8.0;
                v(1, 3) = (xi * zt * (et * 2.0 + 1.0) * (xi - 1.0) * (zt - 1.0)) / 8.0;
                v(1, 4) = (xi * zt * (et * 2.0 - 1.0) * (xi - 1.0) * (zt + 1.0)) / 8.0;
                v(1, 5) = (xi * zt * (et * 2.0 - 1.0) * (xi + 1.0) * (zt + 1.0)) / 8.0;
                v(1, 6) = (xi * zt * (et * 2.0 + 1.0) * (xi + 1.0) * (zt + 1.0)) / 8.0;
                v(1, 7) = (xi * zt * (et * 2.0 + 1.0) * (xi - 1.0) * (zt + 1.0)) / 8.0;
                v(1, 8) = zt * (et * 2.0 - 1.0) * (xi * xi - 1.0) * (zt - 1.0) * (-1.0 / 4.0);
                v(1, 9) = et * xi * zt * (xi + 1.0) * (zt - 1.0) * (-1.0 / 2.0);
                v(1, 10) = zt * (et * 2.0 + 1.0) * (xi * xi - 1.0) * (zt - 1.0) * (-1.0 / 4.0);
                v(1, 11) = et * xi * zt * (xi - 1.0) * (zt - 1.0) * (-1.0 / 2.0);
                v(1, 12) = xi * (et * 2.0 - 1.0) * (zt * zt - 1.0) * (xi - 1.0) * (-1.0 / 4.0);
                v(1, 13) = xi * (et * 2.0 - 1.0) * (zt * zt - 1.0) * (xi + 1.0) * (-1.0 / 4.0);
                v(1, 14) = xi * (et * 2.0 + 1.0) * (zt * zt - 1.0) * (xi + 1.0) * (-1.0 / 4.0);
                v(1, 15) = xi * (et * 2.0 + 1.0) * (zt * zt - 1.0) * (xi - 1.0) * (-1.0 / 4.0);
                v(1, 16) = zt * (et * 2.0 - 1.0) * (xi * xi - 1.0) * (zt + 1.0) * (-1.0 / 4.0);
                v(1, 17) = et * xi * zt * (xi + 1.0) * (zt + 1.0) * (-1.0 / 2.0);
                v(1, 18) = zt * (et * 2.0 + 1.0) * (xi * xi - 1.0) * (zt + 1.0) * (-1.0 / 4.0);
                v(1, 19) = et * xi * zt * (xi - 1.0) * (zt + 1.0) * (-1.0 / 2.0);
                v(1, 20) = et * zt * (xi * xi - 1.0) * (zt - 1.0);
                v(1, 21) = ((et * 2.0 - 1.0) * (xi * xi - 1.0) * (zt * zt - 1.0)) / 2.0;
                v(1, 22) = et * xi * (zt * zt - 1.0) * (xi + 1.0);
                v(1, 23) = ((et * 2.0 + 1.0) * (xi * xi - 1.0) * (zt * zt - 1.0)) / 2.0;
                v(1, 24) = et * xi * (zt * zt - 1.0) * (xi - 1.0);
                v(1, 25) = et * zt * (xi * xi - 1.0) * (zt + 1.0);
                v(1, 26) = et * (xi * xi - 1.0) * (zt * zt - 1.0) * -2.0;
                v(2, 0) = (et * xi * (zt * 2.0 - 1.0) * (et - 1.0) * (xi - 1.0)) / 8.0;
                v(2, 1) = (et * xi * (zt * 2.0 - 1.0) * (et - 1.0) * (xi + 1.0)) / 8.0;
                v(2, 2) = (et * xi * (zt * 2.0 - 1.0) * (et + 1.0) * (xi + 1.0)) / 8.0;
                v(2, 3) = (et * xi * (zt * 2.0 - 1.0) * (et + 1.0) * (xi - 1.0)) / 8.0;
                v(2, 4) = (et * xi * (zt * 2.0 + 1.0) * (et - 1.0) * (xi - 1.0)) / 8.0;
                v(2, 5) = (et * xi * (zt * 2.0 + 1.0) * (et - 1.0) * (xi + 1.0)) / 8.0;
                v(2, 6) = (et * xi * (zt * 2.0 + 1.0) * (et + 1.0) * (xi + 1.0)) / 8.0;
                v(2, 7) = (et * xi * (zt * 2.0 + 1.0) * (et + 1.0) * (xi - 1.0)) / 8.0;
                v(2, 8) = et * (xi * xi - 1.0) * (zt * 2.0 - 1.0) * (et - 1.0) * (-1.0 / 4.0);
                v(2, 9) = xi * (et * et - 1.0) * (zt * 2.0 - 1.0) * (xi + 1.0) * (-1.0 / 4.0);
                v(2, 10) = et * (xi * xi - 1.0) * (zt * 2.0 - 1.0) * (et + 1.0) * (-1.0 / 4.0);
                v(2, 11) = xi * (et * et - 1.0) * (zt * 2.0 - 1.0) * (xi - 1.0) * (-1.0 / 4.0);
                v(2, 12) = et * xi * zt * (et - 1.0) * (xi - 1.0) * (-1.0 / 2.0);
                v(2, 13) = et * xi * zt * (et - 1.0) * (xi + 1.0) * (-1.0 / 2.0);
                v(2, 14) = et * xi * zt * (et + 1.0) * (xi + 1.0) * (-1.0 / 2.0);
                v(2, 15) = et * xi * zt * (et + 1.0) * (xi - 1.0) * (-1.0 / 2.0);
                v(2, 16) = et * (xi * xi - 1.0) * (zt * 2.0 + 1.0) * (et - 1.0) * (-1.0 / 4.0);
                v(2, 17) = xi * (et * et - 1.0) * (zt * 2.0 + 1.0) * (xi + 1.0) * (-1.0 / 4.0);
                v(2, 18) = et * (xi * xi - 1.0) * (zt * 2.0 + 1.0) * (et + 1.0) * (-1.0 / 4.0);
                v(2, 19) = xi * (et * et - 1.0) * (zt * 2.0 + 1.0) * (xi - 1.0) * (-1.0 / 4.0);
                v(2, 20) = ((et * et - 1.0) * (xi * xi - 1.0) * (zt * 2.0 - 1.0)) / 2.0;
                v(2, 21) = et * zt * (xi * xi - 1.0) * (et - 1.0);
                v(2, 22) = xi * zt * (et * et - 1.0) * (xi + 1.0);
                v(2, 23) = et * zt * (xi * xi - 1.0) * (et + 1.0);
                v(2, 24) = xi * zt * (et * et - 1.0) * (xi - 1.0);
                v(2, 25) = ((et * et - 1.0) * (xi * xi - 1.0) * (zt * 2.0 + 1.0)) / 2.0;
                v(2, 26) = zt * (et * et - 1.0) * (xi * xi - 1.0) * -2.0;
            }
        }

        if (t == Prism6)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = (zt / 2.0 - 1.0 / 2.0) * (et + xi - 1.0);
                v(0, 1) = xi * (zt - 1.0) * (-1.0 / 2.0);
                v(0, 2) = et * (zt - 1.0) * (-1.0 / 2.0);
                v(0, 3) = -(zt / 2.0 + 1.0 / 2.0) * (et + xi - 1.0);
                v(0, 4) = xi * (zt / 2.0 + 1.0 / 2.0);
                v(0, 5) = et * (zt / 2.0 + 1.0 / 2.0);
            }
            else
            {
                v(0, 0) = zt / 2.0 - 1.0 / 2.0;
                v(0, 1) = zt * (-1.0 / 2.0) + 1.0 / 2.0;
                v(0, 3) = zt * (-1.0 / 2.0) - 1.0 / 2.0;
                v(0, 4) = zt / 2.0 + 1.0 / 2.0;
                v(1, 0) = zt / 2.0 - 1.0 / 2.0;
                v(1, 2) = zt * (-1.0 / 2.0) + 1.0 / 2.0;
                v(1, 3) = zt * (-1.0 / 2.0) - 1.0 / 2.0;
                v(1, 5) = zt / 2.0 + 1.0 / 2.0;
                v(2, 0) = et / 2.0 + xi / 2.0 - 1.0 / 2.0;
                v(2, 1) = xi * (-1.0 / 2.0);
                v(2, 2) = et * (-1.0 / 2.0);
                v(2, 3) = et * (-1.0 / 2.0) - xi / 2.0 + 1.0 / 2.0;
                v(2, 4) = xi / 2.0;
                v(2, 5) = et / 2.0;
            }
        }

        if (t == Prism18)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = zt * (zt - 1.0) * (et + xi - 1.0) * (et + xi - 1.0 / 2.0);
                v(0, 1) = xi * zt * (xi - 1.0 / 2.0) * (zt - 1.0);
                v(0, 2) = et * zt * (et - 1.0 / 2.0) * (zt - 1.0);
                v(0, 3) = zt * (zt + 1.0) * (et + xi - 1.0) * (et + xi - 1.0 / 2.0);
                v(0, 4) = xi * zt * (xi - 1.0 / 2.0) * (zt + 1.0);
                v(0, 5) = et * zt * (et - 1.0 / 2.0) * (zt + 1.0);
                v(0, 6) = -xi * zt * (zt - 1.0) * (et * 2.0 + xi * 2.0 - 2.0);
                v(0, 7) = et * xi * zt * (zt - 1.0) * 2.0;
                v(0, 8) = et * zt * (zt - 1.0) * (et + xi - 1.0) * -2.0;
                v(0, 9) = (zt - 1.0) * (zt + 1.0) * (et + xi - 1.0) * (et + xi - 1.0 / 2.0) * -2.0;
                v(0, 10) = xi * (xi - 1.0 / 2.0) * (zt - 1.0) * (zt + 1.0) * -2.0;
                v(0, 11) = et * (et - 1.0 / 2.0) * (zt - 1.0) * (zt + 1.0) * -2.0;
                v(0, 12) = -xi * zt * (zt + 1.0) * (et * 2.0 + xi * 2.0 - 2.0);
                v(0, 13) = et * xi * zt * (zt + 1.0) * 2.0;
                v(0, 14) = et * zt * (zt + 1.0) * (et + xi - 1.0) * -2.0;
                v(0, 15) = xi * (zt - 1.0) * (zt + 1.0) * (et * 2.0 + xi * 2.0 - 2.0) * 2.0;
                v(0, 16) = et * xi * (zt - 1.0) * (zt + 1.0) * -4.0;
                v(0, 17) = et * (zt - 1.0) * (zt + 1.0) * (et + xi - 1.0) * 4.0;
            }
            else
            {
                v(0, 0) = (zt * (zt - 1.0) * (et * 4.0 + xi * 4.0 - 3.0)) / 2.0;
                v(0, 1) = (zt * (xi * 4.0 - 1.0) * (zt - 1.0)) / 2.0;
                v(0, 3) = (zt * (zt + 1.0) * (et * 4.0 + xi * 4.0 - 3.0)) / 2.0;
                v(0, 4) = (zt * (xi * 4.0 - 1.0) * (zt + 1.0)) / 2.0;
                v(0, 6) = zt * (zt - 1.0) * (et + xi * 2.0 - 1.0) * -2.0;
                v(0, 7) = et * zt * (zt - 1.0) * 2.0;
                v(0, 8) = et * zt * (zt - 1.0) * -2.0;
                v(0, 9) = -(zt * zt - 1.0) * (et * 4.0 + xi * 4.0 - 3.0);
                v(0, 10) = -(xi * 4.0 - 1.0) * (zt * zt - 1.0);
                v(0, 12) = zt * (zt + 1.0) * (et + xi * 2.0 - 1.0) * -2.0;
                v(0, 13) = et * zt * (zt + 1.0) * 2.0;
                v(0, 14) = et * zt * (zt + 1.0) * -2.0;
                v(0, 15) = (zt * zt - 1.0) * (et + xi * 2.0 - 1.0) * 4.0;
                v(0, 16) = et * (zt - 1.0) * (zt + 1.0) * -4.0;
                v(0, 17) = et * (zt - 1.0) * (zt + 1.0) * 4.0;
                v(1, 0) = (zt * (zt - 1.0) * (et * 4.0 + xi * 4.0 - 3.0)) / 2.0;
                v(1, 2) = (zt * (et * 4.0 - 1.0) * (zt - 1.0)) / 2.0;
                v(1, 3) = (zt * (zt + 1.0) * (et * 4.0 + xi * 4.0 - 3.0)) / 2.0;
                v(1, 5) = (zt * (et * 4.0 - 1.0) * (zt + 1.0)) / 2.0;
                v(1, 6) = xi * zt * (zt - 1.0) * -2.0;
                v(1, 7) = xi * zt * (zt - 1.0) * 2.0;
                v(1, 8) = zt * (zt - 1.0) * (et * 2.0 + xi - 1.0) * -2.0;
                v(1, 9) = -(zt * zt - 1.0) * (et * 4.0 + xi * 4.0 - 3.0);
                v(1, 11) = -(et * 4.0 - 1.0) * (zt * zt - 1.0);
                v(1, 12) = xi * zt * (zt + 1.0) * -2.0;
                v(1, 13) = xi * zt * (zt + 1.0) * 2.0;
                v(1, 14) = zt * (zt + 1.0) * (et * 2.0 + xi - 1.0) * -2.0;
                v(1, 15) = xi * (zt - 1.0) * (zt + 1.0) * 4.0;
                v(1, 16) = xi * (zt - 1.0) * (zt + 1.0) * -4.0;
                v(1, 17) = (zt * zt - 1.0) * (et * 2.0 + xi - 1.0) * 4.0;
                v(2, 0) = zt * (et + xi - 1.0) * (et + xi - 1.0 / 2.0) + (zt - 1.0) * (et + xi - 1.0) * (et + xi - 1.0 / 2.0);
                v(2, 1) = (xi * (xi * 2.0 - 1.0) * (zt * 2.0 - 1.0)) / 2.0;
                v(2, 2) = (et * (et * 2.0 - 1.0) * (zt * 2.0 - 1.0)) / 2.0;
                v(2, 3) = zt * (et + xi - 1.0) * (et + xi - 1.0 / 2.0) + (zt + 1.0) * (et + xi - 1.0) * (et + xi - 1.0 / 2.0);
                v(2, 4) = (xi * (xi * 2.0 - 1.0) * (zt * 2.0 + 1.0)) / 2.0;
                v(2, 5) = (et * (et * 2.0 - 1.0) * (zt * 2.0 + 1.0)) / 2.0;
                v(2, 6) = xi * (zt * 2.0 - 1.0) * (et + xi - 1.0) * -2.0;
                v(2, 7) = et * xi * (zt * 2.0 - 1.0) * 2.0;
                v(2, 8) = et * (zt * 2.0 - 1.0) * (et + xi - 1.0) * -2.0;
                v(2, 9) = (zt - 1.0) * (et + xi - 1.0) * (et + xi - 1.0 / 2.0) * -2.0 - (zt + 1.0) * (et + xi - 1.0) * (et + xi - 1.0 / 2.0) * 2.0;
                v(2, 10) = xi * zt * (xi * 2.0 - 1.0) * -2.0;
                v(2, 11) = et * zt * (et * 2.0 - 1.0) * -2.0;
                v(2, 12) = xi * (zt * 2.0 + 1.0) * (et + xi - 1.0) * -2.0;
                v(2, 13) = et * xi * (zt * 2.0 + 1.0) * 2.0;
                v(2, 14) = et * (zt * 2.0 + 1.0) * (et + xi - 1.0) * -2.0;
                v(2, 15) = xi * zt * (et + xi - 1.0) * 8.0;
                v(2, 16) = et * xi * zt * -8.0;
                v(2, 17) = et * zt * (et + xi - 1.0) * 8.0;
            }
        }

        if (t == Pyramid5)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = -(et / 2.0 - 1.0 / 2.0) * (xi / 2.0 - 1.0 / 2.0) * (zt - 1.0);
                v(0, 1) = (et / 2.0 - 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0) * (zt - 1.0);
                v(0, 2) = -(et / 2.0 + 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0) * (zt - 1.0);
                v(0, 3) = (et / 2.0 + 1.0 / 2.0) * (xi / 2.0 - 1.0 / 2.0) * (zt - 1.0);
                v(0, 4) = zt;
            }
            else
            {
                v(0, 0) = (et / 2.0 - 1.0 / 2.0) * (zt - 1.0) * (-1.0 / 2.0);
                v(0, 1) = ((et / 2.0 - 1.0 / 2.0) * (zt - 1.0)) / 2.0;
                v(0, 2) = (et / 2.0 + 1.0 / 2.0) * (zt - 1.0) * (-1.0 / 2.0);
                v(0, 3) = ((et / 2.0 + 1.0 / 2.0) * (zt - 1.0)) / 2.0;
                v(1, 0) = (xi / 2.0 - 1.0 / 2.0) * (zt - 1.0) * (-1.0 / 2.0);
                v(1, 1) = ((xi / 2.0 + 1.0 / 2.0) * (zt - 1.0)) / 2.0;
                v(1, 2) = (xi / 2.0 + 1.0 / 2.0) * (zt - 1.0) * (-1.0 / 2.0);
                v(1, 3) = ((xi / 2.0 - 1.0 / 2.0) * (zt - 1.0)) / 2.0;
                v(2, 0) = (et - 1.0) * (xi - 1.0) * (-1.0 / 4.0);
                v(2, 1) = (et / 2.0 - 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0);
                v(2, 2) = -(et / 2.0 + 1.0 / 2.0) * (xi / 2.0 + 1.0 / 2.0);
                v(2, 3) = (et / 2.0 + 1.0 / 2.0) * (xi / 2.0 - 1.0 / 2.0);
                v(2, 4) = 1.0;
            }
        }

        if (t == Pyramid14)
        {
            if constexpr (diffOrder == 0)
            {
                v(0, 0) = (et * xi * (zt * 2.0 - 1.0) * (zt * 2.0 - 2.0) * (et - 1.0) * (xi - 1.0)) / 8.0;
                v(0, 1) = (et * xi * (zt * 2.0 - 1.0) * (zt * 2.0 - 2.0) * (et - 1.0) * (xi + 1.0)) / 8.0;
                v(0, 2) = (et * xi * (zt * 2.0 - 1.0) * (zt * 2.0 - 2.0) * (et + 1.0) * (xi + 1.0)) / 8.0;
                v(0, 3) = (et * xi * (zt * 2.0 - 1.0) * (zt * 2.0 - 2.0) * (et + 1.0) * (xi - 1.0)) / 8.0;
                v(0, 4) = zt * (zt * 2.0 - 1.0);
                v(0, 5) = et * (zt * 2.0 - 1.0) * (zt * 2.0 - 2.0) * (et - 1.0) * (xi - 1.0) * (xi + 1.0) * (-1.0 / 4.0);
                v(0, 6) = xi * (zt * 2.0 - 1.0) * (zt * 2.0 - 2.0) * (et - 1.0) * (et + 1.0) * (xi + 1.0) * (-1.0 / 4.0);
                v(0, 7) = et * (zt * 2.0 - 1.0) * (zt * 2.0 - 2.0) * (et + 1.0) * (xi - 1.0) * (xi + 1.0) * (-1.0 / 4.0);
                v(0, 8) = xi * (zt * 2.0 - 1.0) * (zt * 2.0 - 2.0) * (et - 1.0) * (et + 1.0) * (xi - 1.0) * (-1.0 / 4.0);
                v(0, 9) = zt * (zt * 2.0 - 2.0) * (et - 1.0 / 2.0) * (xi - 1.0 / 2.0) * -2.0;
                v(0, 10) = zt * (zt * 2.0 - 2.0) * (et - 1.0 / 2.0) * (xi + 1.0 / 2.0) * 2.0;
                v(0, 11) = zt * (zt * 2.0 - 2.0) * (et + 1.0 / 2.0) * (xi + 1.0 / 2.0) * -2.0;
                v(0, 12) = zt * (zt * 2.0 - 2.0) * (et + 1.0 / 2.0) * (xi - 1.0 / 2.0) * 2.0;
                v(0, 13) = ((zt * 2.0 - 1.0) * (zt * 2.0 - 2.0) * (et - 1.0) * (et + 1.0) * (xi - 1.0) * (xi + 1.0)) / 2.0;
            }
            else
            {
                v(0, 0) = (et * (xi * 2.0 - 1.0) * (et - 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0)) / 4.0;
                v(0, 1) = (et * (xi * 2.0 + 1.0) * (et - 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0)) / 4.0;
                v(0, 2) = (et * (xi * 2.0 + 1.0) * (et + 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0)) / 4.0;
                v(0, 3) = (et * (xi * 2.0 - 1.0) * (et + 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0)) / 4.0;
                v(0, 5) = -et * xi * (et - 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0);
                v(0, 6) = (et * et - 1.0) * (xi * 2.0 + 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0) * (-1.0 / 2.0);
                v(0, 7) = -et * xi * (et + 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0);
                v(0, 8) = (et * et - 1.0) * (xi * 2.0 - 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0) * (-1.0 / 2.0);
                v(0, 9) = zt * (zt * 2.0 - 2.0) * (et - 1.0 / 2.0) * -2.0;
                v(0, 10) = zt * (zt * 2.0 - 2.0) * (et - 1.0 / 2.0) * 2.0;
                v(0, 11) = zt * (zt * 2.0 - 2.0) * (et + 1.0 / 2.0) * -2.0;
                v(0, 12) = zt * (zt * 2.0 - 2.0) * (et + 1.0 / 2.0) * 2.0;
                v(0, 13) = xi * (et * et - 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0) * 2.0;
                v(1, 0) = (xi * (et * 2.0 - 1.0) * (xi - 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0)) / 4.0;
                v(1, 1) = (xi * (et * 2.0 - 1.0) * (xi + 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0)) / 4.0;
                v(1, 2) = (xi * (et * 2.0 + 1.0) * (xi + 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0)) / 4.0;
                v(1, 3) = (xi * (et * 2.0 + 1.0) * (xi - 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0)) / 4.0;
                v(1, 5) = (et * 2.0 - 1.0) * (xi * xi - 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0) * (-1.0 / 2.0);
                v(1, 6) = -et * xi * (xi + 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0);
                v(1, 7) = (et * 2.0 + 1.0) * (xi * xi - 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0) * (-1.0 / 2.0);
                v(1, 8) = -et * xi * (xi - 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0);
                v(1, 9) = zt * (zt * 2.0 - 2.0) * (xi - 1.0 / 2.0) * -2.0;
                v(1, 10) = zt * (zt * 2.0 - 2.0) * (xi + 1.0 / 2.0) * 2.0;
                v(1, 11) = zt * (zt * 2.0 - 2.0) * (xi + 1.0 / 2.0) * -2.0;
                v(1, 12) = zt * (zt * 2.0 - 2.0) * (xi - 1.0 / 2.0) * 2.0;
                v(1, 13) = et * (xi * xi - 1.0) * (zt * -3.0 + (zt * zt) * 2.0 + 1.0) * 2.0;
                v(2, 0) = (et * xi * (zt * 4.0 - 3.0) * (et - 1.0) * (xi - 1.0)) / 4.0;
                v(2, 1) = (et * xi * (zt * 4.0 - 3.0) * (et - 1.0) * (xi + 1.0)) / 4.0;
                v(2, 2) = (et * xi * (zt * 4.0 - 3.0) * (et + 1.0) * (xi + 1.0)) / 4.0;
                v(2, 3) = (et * xi * (zt * 4.0 - 3.0) * (et + 1.0) * (xi - 1.0)) / 4.0;
                v(2, 4) = zt * 4.0 - 1.0;
                v(2, 5) = et * (xi * xi - 1.0) * (zt * 4.0 - 3.0) * (et - 1.0) * (-1.0 / 2.0);
                v(2, 6) = xi * (et * et - 1.0) * (zt * 4.0 - 3.0) * (xi + 1.0) * (-1.0 / 2.0);
                v(2, 7) = et * (xi * xi - 1.0) * (zt * 4.0 - 3.0) * (et + 1.0) * (-1.0 / 2.0);
                v(2, 8) = xi * (et * et - 1.0) * (zt * 4.0 - 3.0) * (xi - 1.0) * (-1.0 / 2.0);
                v(2, 9) = -(et * 2.0 - 1.0) * (xi * 2.0 - 1.0) * (zt * 2.0 - 1.0);
                v(2, 10) = (et * 2.0 - 1.0) * (xi * 2.0 + 1.0) * (zt * 2.0 - 1.0);
                v(2, 11) = -(et * 2.0 + 1.0) * (xi * 2.0 + 1.0) * (zt * 2.0 - 1.0);
                v(2, 12) = (et * 2.0 + 1.0) * (xi * 2.0 - 1.0) * (zt * 2.0 - 1.0);
                v(2, 13) = (et * et - 1.0) * (xi * xi - 1.0) * (zt * 4.0 - 3.0);
            }
        }
        DNDS_assert(false);
    }

    using tNj = Eigen::RowVector<t_real, Eigen::Dynamic>;
    using tD1Nj = Eigen::Matrix<t_real, 3, Eigen::Dynamic>;
    using tD01Nj = Eigen::Matrix<t_real, 4, Eigen::Dynamic>;

    struct Element
    {
        ElemType type = UnknownElem;

        constexpr ParamSpace GetParamSpace() const
        {
            return ElemType_to_ParamSpace(type);
        }

        constexpr t_index GetDim() const
        {
            return Dim_Order_NVNNNF[type][0];
        }

        constexpr t_index GetOrder() const
        {
            return Dim_Order_NVNNNF[type][1];
        }

        constexpr t_index GetNumVertices() const
        {
            return Dim_Order_NVNNNF[type][2];
        }

        constexpr t_index GetNumNodes() const
        {
            return Dim_Order_NVNNNF[type][3];
        }

        constexpr t_index GetNumFaces() const
        {
            return Dim_Order_NVNNNF[type][4];
        }

        constexpr Element ObtainFace(t_index iFace) const
        {
            DNDS_assert(iFace < this->GetNumFaces());
            return Element{GetFaceType(type, iFace)};
        }

        /**
         * @warning assuming Out has correct size
         */
        template <class TIn, class TOut>
        void ExtractFaceNodes(t_index iFace, const TIn &nodes, TOut &faceNodes)
        {
            DNDS_assert(iFace < this->GetNumFaces());
            for (t_index i = 0; i < ObtainFace(iFace).GetNumFaces(); i++)
                faceNodes[i] = nodes[FaceNodeList[type][iFace][i]];
        }

        /**
         * @warning Nj resized within
         */
        void GetNj(const tPoint &pParam, tNj &Nj)
        {
            Nj.resize(1, this->GetNumNodes());
            ShapeFunc_DiNj<0>(type, pParam, Nj);
        }

        /**
         * @warning D1Nj resized within
         */
        void GetD1Nj(const tPoint &pParam, tD1Nj &D1Nj)
        {
            D1Nj.resize(3, this->GetNumNodes());
            ShapeFunc_DiNj<1>(type, pParam, D1Nj);
        }

        /**
         * @warning DiNj resized within
         */
        void GetD01Nj(const tPoint &pParam, tD01Nj &D01Nj)
        {
            tNj Nj;
            tD1Nj D1Nj;
            this->GetNj(pParam, Nj);
            this->GetD1Nj(pParam, D1Nj);

            tD01Nj D01Nj;
            D01Nj.resize(4, this->GetNumNodes());
            D01Nj(0, Eigen::all) = Nj;
            D01Nj({1, 2, 3}, Eigen::all) = D1Nj;
        }
    };
}